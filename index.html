<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“ Supabase Notes</title>

  <!-- ESâ€‘module SDK (fast, cacheâ€‘friendly) -->
  <script type="module" crossorigin src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
         background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
         min-height:100vh;padding:20px}
    .container{max-width:500px;margin:auto;background:#fff;border-radius:20px;
               padding:26px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
    h1{text-align:center;margin-bottom:20px}
    .debug{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;
           padding:10px;font:14px/1.5 monospace;white-space:pre-wrap;
           height:200px;overflow-y:auto;margin-bottom:18px}
    button,textarea{width:100%;font-size:16px;padding:14px;border-radius:10px;
                    border:none;margin-bottom:12px}
    button{font-weight:600;cursor:pointer;transition:.25s}
    .btn-google{background:#4285f4;color:#fff}.btn-google:hover{background:#3367d6}
    .btn-logout{background:#dc3545;color:#fff}
    .btn-save{background:#28a745;color:#fff}
    textarea{border:2px solid #dee2e6;min-height:170px;resize:vertical}
    textarea:focus{outline:none;border-color:#4285f4}
    #notesList .note{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;
                     padding:12px;margin-bottom:8px}
    #notesList .meta{font-size:12px;color:#6c757d;margin-bottom:6px}
    .hidden{display:none}
    #status{position:fixed;top:0;left:0;right:0;padding:6px;text-align:center;
            font-weight:600;color:#fff;z-index:50;transition:opacity .3s}
    #status.ok{background:#28a745}#status.err{background:#dc3545}
  </style>
</head>
<body>
  <div id="status" class="hidden"></div>

  <div class="container">
    <h1>ğŸ“ Notes App</h1>
    <div id="debug" class="debug">App startingâ€¦</div>

    <!-- login -->
    <div id="loginSection">
      <button id="loginBtn" class="btn-google">ğŸ” Sign in with Google</button>
    </div>

    <!-- app -->
    <div id="userSection" class="hidden">
      <div id="userInfo" style="text-align:center;margin-bottom:18px"></div>
      <button id="logoutBtn" class="btn-logout">ğŸšª Logout</button>

      <textarea id="noteText" placeholder="Write your noteâ€¦"></textarea>
      <button id="saveBtn" class="btn-save">ğŸ’¾ Save Note</button>

      <div id="notesList"></div>
    </div>
  </div>

<script type="module">
/* --------------- CONFIG ------------------------------------- */
const URL = "https://pmceyfxrrbyipwmedfqc.supabase.co";
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtY2V5ZnhycmJ5aXB3bWVkZnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NzE2MDUsImV4cCI6MjA2ODE0NzYwNX0.CMhnfpuhB7V1CpC82kKDQoqRig--QEK5ItkFFol8seU";

/* --------------- helper refs -------------------------------- */
const dbg   = document.getElementById("debug");
const banner= document.getElementById("status");
function log(m){dbg.textContent += `\n${new Date().toLocaleTimeString()}: ${m}`; dbg.scrollTop = dbg.scrollHeight;}
function show(msg, ok){banner.textContent = msg; banner.className = ok ? "ok" : "err"; banner.classList.remove("hidden"); setTimeout(()=>banner.classList.add("hidden"), 3000);}
window.addEventListener("unhandledrejection", e=>log("âš ï¸  Unhandled: "+e.reason));

/* --------------- Supabase client ---------------------------- */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const sb = createClient(URL, KEY, {
  auth:{
    autoRefreshToken:true,
    persistSession:true,
    detectSessionInUrl:true
  }
});
log("âœ… Client created");

/* --------------- elements ---------------------------------- */
const loginSec  = document.getElementById("loginSection");
const userSec   = document.getElementById("userSection");
const loginBtn  = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const saveBtn   = document.getElementById("saveBtn");
const noteText  = document.getElementById("noteText");
const notesList = document.getElementById("notesList");
const userInfo  = document.getElementById("userInfo");

let currentUser = null;

/* --------------- utility ----------------------------------- */
function updateUI(){
  if(currentUser){
    loginSec.classList.add("hidden");
    userSec.classList.remove("hidden");
    userInfo.textContent = `Logged in as ${currentUser.email}`;
  }else{
    userSec.classList.add("hidden");
    loginSec.classList.remove("hidden");
    userInfo.textContent = "";
    notesList.innerHTML = "";
    noteText.value = "";
  }
}

/* --- safe wrapper that retries once on token refresh & times out --- */
async function safe(op, label=""){  // op is a ()=>Promise<{data,error}>
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 10000); // 10â€¯s hard timeout
  try{
    let {data,error} = await op({signal:controller.signal});
    if(error?.status === 401){      // token expired race â€” refresh then retry
      log("ğŸ”„ Token expired, refreshingâ€¦");
      await sb.auth.refreshSession();
      ({data,error} = await op({signal:controller.signal}));
    }
    if(error) throw error;
    return data;
  }catch(e){
    log(`âŒ ${label||"request"}: `+e.message);
    show(e.message,false);
    throw e;
  }finally{
    clearTimeout(timeout);
  }
}

/* --------------- NOTES ------------------------------------- */
async function loadNotes(){
  log("ğŸ”„ loadNotes()");
  const rows = await safe(
    () => sb.from("notes")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at",{ascending:false}),
    "loadNotes"
  );
  notesList.innerHTML = "";
  rows.forEach(r=>{
    const div=document.createElement("div");
    div.className="note";
    div.innerHTML = `<div class="meta">${new Date(r.created_at).toLocaleString()}</div>${r.content}`;
    notesList.appendChild(div);
  });
  log(`âœ… loaded ${rows.length}`);
}

/* --------------- EVENTS ------------------------------------ */
loginBtn.onclick = async ()=>{
  log("â¡ï¸ login click");
  const {error} = await sb.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:location.href}
  });
  if(error){ log("âŒ OAuth: "+error.message); show(error.message,false); }
};

logoutBtn.onclick = async ()=>{
  log("â¡ï¸ logout click");
  const {error} = await sb.auth.signOut();
  if(error){
    log("âŒ signOut: "+error.message);
    show(error.message,false);
  }else{
    /* Fallback: some WebViews drop the SIGNED_OUT event */
    setTimeout(()=>{
      if(sb.auth.getSession().data.session){
        log("âš ï¸  signOut event missing â€” forcing clear");
        sb.auth.setSession(null);
        currentUser=null; updateUI(); show("Logged out",true);
      }
    },2000);
  }
};

saveBtn.onclick = async ()=>{
  const content = noteText.value.trim();
  if(!content){ show("Write something first!",false); return; }
  await safe(
    () => sb.from("notes")
            .insert({user_id:currentUser.id, content})
            .select(),
    "insert"
  );
  noteText.value = "";
  show("Saved",true);
  await loadNotes();
};

/* --------------- AUTH LISTENER ----------------------------- */
sb.auth.onAuthStateChange(async(ev,session)=>{
  log("ğŸ“¢ auth event: "+ev);
  currentUser = session?.user || null;
  updateUI();
  if(currentUser && ev!=="SIGNED_OUT") await loadNotes();
});

/* --------------- FIRST LOAD ------------------------------- */
const {data:{session}} = await sb.auth.getSession();
currentUser = session?.user || null;
updateUI();
if(currentUser) await loadNotes();
log("âœ… initial session ready");
</script>
</body>
</html>
