<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>ğŸ“ Supabase Notes</title>

Â  Â  <script type="module" crossorigin
Â  Â  Â  Â  Â  src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>

Â  <style>
Â  Â  *{margin:0;padding:0;box-sizing:border-box}
Â  Â  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
Â  Â  Â  Â  Â background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
Â  Â  Â  Â  Â min-height:100vh;padding:20px}
Â  Â  .container{max-width:500px;margin:auto;background:#fff;border-radius:20px;
Â  Â  Â  Â  Â  Â  Â  Â padding:25px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
Â  Â  h1{text-align:center;margin-bottom:20px}
Â  Â  .debug{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;
Â  Â  Â  Â  Â  Â padding:10px;font:14px/1.5 monospace;white-space:pre-wrap;
Â  Â  Â  Â  Â  Â height:200px;overflow-y:auto;margin-bottom:18px}
Â  Â  button,textarea,input[type="text"]{width:100%;font-size:16px;padding:14px;border-radius:10px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border:none;margin-bottom:12px}
Â  Â  button{font-weight:600;cursor:pointer;transition:.25s}
Â  Â  .btn-google{background:#4285f4;color:#fff}.btn-google:hover{background:#3367d6}
Â  Â  .btn-logout{background:#dc3545;color:#fff}
Â  Â  .btn-save{background:#28a745;color:#fff}
    .btn-primary {background:#007bff; color:#fff;} .btn-primary:hover {background:#0056b3;}
    .btn-success {background:#28a745; color:#fff;} .btn-success:hover {background:#218838;}
    .btn-danger {background:#dc3545; color:#fff;} .btn-danger:hover {background:#c82333;}
Â  Â  textarea, input[type="text"]{border:2px solid #dee2e6;min-height:40px;resize:vertical}
Â  Â  textarea:focus, input[type="text"]:focus{outline:none;border-color:#4285f4}
Â  Â  #notesList .note{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â padding:12px;margin-bottom:8px}
Â  Â  #notesList .meta{font-size:12px;color:#6c757d;margin-bottom:6px}
    .note-owner { font-weight: bold; margin-bottom: 4px; }
Â  Â  .hidden{display:none}
Â  Â  #status{position:fixed;top:0;left:0;right:0;padding:6px;text-align:center;
Â  Â  Â  Â  Â  Â  font-weight:600;color:#fff;z-index:50;transition:opacity .3s}
Â  Â  #status.ok{background:#28a745}#status.err{background:#dc3545}

    /* Styles for dropdown and friend request list */
    select {
        width: 100%;
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 12px;
        font-size: 16px;
        background-color: white;
    }
    select:focus {
        outline: none;
        border-color: #4285f4;
    }
    .section-header {
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.2em;
        font-weight: 600;
        color: #333;
    }
    .friend-request-item {
        background:#f8f9fa;
        border:1px solid #dee2e6;
        border-radius:8px;
        padding:12px;
        margin-bottom:8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .friend-request-item button {
        width: auto;
        margin-left: 10px;
        margin-bottom: 0; /* Override global button margin-bottom */
    }
    .flex-buttons {
        display: flex;
        gap: 8px;
    }
Â  </style>
</head>
<body>
<div id="status" class="hidden"></div>

<div class="container">
Â  <h1>ğŸ“ Supabase Notes</h1>
Â  <div id="debug" class="debug">App startingâ€¦</div>

Â  <div id="loginSection">
Â  Â  <button id="loginBtn" class="btn-google">ğŸ” Sign in with Google</button>
Â  </div>

Â  <div id="userSection" class="hidden">
Â  Â  <div id="userInfo" style="text-align:center;margin-bottom:18px"></div>
Â  Â  <button id="logoutBtn" class="btn-logout">ğŸšª Logout</button>

    <hr>
    <div id="profileSection">
        <div class="section-header">Your Profile</div>
        <input type="text" id="usernameInput" placeholder="Set or change your username" />
        <button id="saveUsernameBtn" class="btn-primary">Save Username</button>
        <div id="currentUsername" style="margin-bottom:12px; font-weight:bold;"></div>
    </div>

    <hr>
    <div id="friendRequestSection">
        <div class="section-header">Send Friend Request</div>
        <select id="userDropdown"></select>
        <button id="sendFriendRequestBtn" class="btn-primary">Send Request</button>
    </div>

    <hr>
    <div id="incomingRequestsSection">
        <div class="section-header">Incoming Friend Requests</div>
        <div id="incomingRequestsList"></div>
    </div>

    <hr>
Â  Â  <textarea id="noteText" placeholder="Write your noteâ€¦"></textarea>
Â  Â  <button id="saveBtn" class="btn-save">ğŸ’¾ Save Note</button>
Â  Â  <button id="pingBtn" style="background:#17a2b8;color:#fff">ğŸ” Ping REST</button>

    <hr>
    <div class="section-header">Your Notes and Friends' Notes</div>
Â  Â  <div id="notesList"></div>
Â  </div>
</div>
<script type="module">
/* ------------------------------------------------------------------
Â  Â SUPABASE CONFIG
Â  Â ------------------------------------------------------------------
Â  Â â€¢ We use the â€œanonâ€ public key â€”â€¯NEVER embed the serviceâ€‘role key
Â  Â  Â in clientâ€‘side code.
Â  Â â€¢ detectSessionInUrl:true lets the SDK parse #access_token on login.
Â  Â â€¢ persistSession:true stores the session in localStorage so a refresh
Â  Â  Â keeps the user signedâ€‘in.
------------------------------------------------------------------- */
const URL = "https://pmceyfxrrbyipwmedfqc.supabase.co"; // REPLACE WITH YOUR SUPABASE PROJECT URL
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtY2V5ZnhycmJ5aXB3bWVkZnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NzE2MDUsImV4cCI6MjA2ODE0NzYwNX0.CMhnfpuhB7V1CpC82kKDQoqRig--QEK5ItkFFol8seU"; // REPLACE WITH YOUR SUPABASE ANON PUBLIC KEY

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const sb = createClient(URL, KEY, {
Â  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* ------------------------------------------------------------------
Â  Â DOM HELPERS & LOGGING
Â  Â ------------------------------------------------------------------ */
const dbgÂ  Â  = document.getElementById("debug");
const banner = document.getElementById("status");

function log(msg){
Â  dbg.textContent += `\n${new Date().toLocaleTimeString()}: ${msg}`;
Â  dbg.scrollTopÂ  Â  = dbg.scrollHeight;
}
function show(msg, ok){
Â  banner.textContent = msg;
Â  banner.classNameÂ  Â = ok ? "ok" : "err";
Â  banner.classList.remove("hidden");
Â  setTimeout(()=>banner.classList.add("hidden"), 3000);
}
window.addEventListener("unhandledrejection", e =>
Â  log("âš ï¸Â  " + (e.reason?.message || e.reason))
);

log("âœ… Supabase client ready");

/* ------------------------------------------------------------------
Â  Â ELEMENT REFERENCES
------------------------------------------------------------------- */
const loginSec = document.getElementById("loginSection");
const userSecÂ  = document.getElementById("userSection");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn= document.getElementById("logoutBtn");
const saveBtnÂ  = document.getElementById("saveBtn");
const pingBtnÂ  = document.getElementById("pingBtn");
const noteTxtÂ  = document.getElementById("noteText");
const listÂ  Â  Â = document.getElementById("notesList");
const userInfo = document.getElementById("userInfo");

// New element references for profiles/friends
const usernameInput = document.getElementById("usernameInput");
const saveUsernameBtn = document.getElementById("saveUsernameBtn");
const currentUsernameDisplay = document.getElementById("currentUsername");
const userDropdown = document.getElementById("userDropdown");
const sendFriendRequestBtn = document.getElementById("sendFriendRequestBtn");
const incomingRequestsList = document.getElementById("incomingRequestsList");

/* ------------------------------------------------------------------
Â  Â STATE + UI
------------------------------------------------------------------- */
let currentUser = null;
let currentUsername = null;
let allUsers = []; // To store users for dropdown

function updateUI(){
Â  if(currentUser){
Â  Â  loginSec.classList.add("hidden");
Â  Â  userSec.classList.remove("hidden");
Â  Â  userInfo.textContent = `Logged in as ${currentUser.email}`;
    // Show current username or a loading/placeholder message
    currentUsernameDisplay.textContent = currentUsername ? `Your username: @${currentUsername}` : "Loading username...";
Â  }else{
Â  Â  userSec.classList.add("hidden");
Â  Â  loginSec.classList.remove("hidden");
Â  Â  userInfo.textContent = "";
Â  Â  noteTxt.valueÂ  Â  Â  Â  = "";
Â  Â  list.innerHTMLÂ  Â  Â  Â = "";
    currentUsernameDisplay.textContent = "";
    usernameInput.value = ""; // Clear username input
    userDropdown.innerHTML = "";
    incomingRequestsList.innerHTML = "";
Â  }
}

/* ------------------------------------------------------------------
Â  Â safe(label, fn)Â  â€” CALL WRAPPER
Â  Â ------------------------------------------------------------------
Â  Â â€¢ Adds an 8â€‘second timeout so a stalled network call never hangs the UI.
Â  Â â€¢ Automatically retries once if we hit a 401 during token refresh.
Â  Â â€¢ Centralised error â†’ always log + banner in one place.
Â  Â ** âš ï¸ Do NOT delete this wrapper. **
------------------------------------------------------------------- */
async function safe(label, fn){
Â  const ctrl = new AbortController();
Â  const tÂ  Â  = setTimeout(() => ctrl.abort(), 8000);
Â  try{
Â  Â  let { data, error } = await fn(ctrl.signal);
Â  Â  if(error?.status === 401){
Â  Â  Â  await sb.auth.refreshSession();
Â  Â  Â  ({ data, error } = await fn(ctrl.signal));
Â  Â  }
Â  Â  if(error) throw error;
Â  Â  return data;
Â  }catch(e){
Â  Â  log(`âŒ ${label}: ${e.message}`);
Â  Â  show(e.message,false);
Â  }finally{
Â  Â  clearTimeout(t);
Â  }
}

/* ------------------------------------------------------------------
Â  Â PROFILE MANAGEMENT
------------------------------------------------------------------- */
async function loadUserProfile() {
    if (!currentUser) return;
    log("ğŸ”„ loadUserProfile()");
    const { data, error } = await sb
        .from('profiles')
        .select('username')
        .eq('id', currentUser.id)
        .single(); // Use single() as there should only be one profile per user

    if (error && error.code === 'PGRST116') { // PGRST116 means "No rows found"
        // This case would happen if a user existed BEFORE the trigger/backfill was applied.
        log("â„¹ï¸ No profile found for current user. It should be auto-generated soon.");
        currentUsername = null;
        usernameInput.value = '';
    } else if (error) {
        log(`âŒ loadUserProfile: ${error.message}`);
        currentUsername = null;
    } else if (data) {
        currentUsername = data.username;
        usernameInput.value = data.username;
        log(`âœ… User profile loaded: @${currentUsername}`);
    }
    updateUI();
}

async function saveUsername() {
    const newUsername = usernameInput.value.trim();
    if (!newUsername) {
        show("Username cannot be empty!", false);
        return;
    }
    if (!currentUser) {
        show("Please sign in to save your username.", false);
        return;
    }

    // Check if username already exists for another user
    const { data: existingUser, error: existingError } = await sb
        .from('profiles')
        .select('id')
        .eq('username', newUsername)
        .not('id', 'eq', currentUser.id) // Ensure it's not the current user's existing username
        .maybeSingle();

    if (existingError) {
        show(existingError.message, false);
        return;
    }

    if (existingUser) { // If data is not null, a different user has this username
        show("Username already taken! Please choose another.", false);
        return;
    }

    // Upsert (insert or update) the profile
    const { data, error } = await sb
        .from('profiles')
        .upsert({ id: currentUser.id, username: newUsername }, { onConflict: 'id' });

    if (error) {
        log(`âŒ saveUsername: ${error.message}`);
        show(error.message, false);
    } else {
        currentUsername = newUsername;
        show("Username saved!", true);
        log(`âœ… Username saved: @${newUsername}`);
        updateUI();
        await loadAllUsersForDropdown(); // Refresh dropdown after username change
    }
}

/* ------------------------------------------------------------------
Â  Â USER AND FRIEND REQUESTS
------------------------------------------------------------------- */
async function loadAllUsersForDropdown() {
    log("ğŸ”„ Loading all users for dropdown...");
    // Select from the 'profiles' table to get usernames and IDs
    const { data, error } = await safe("loadAllUsers", signal =>
        sb.from('profiles').select('id, username', { signal }).neq('id', currentUser.id) // Exclude current user
    );

    if (error) {
        log(`âŒ loadAllUsersForDropdown: ${error.message}`);
        return;
    }
    allUsers = data;
    userDropdown.innerHTML = '<option value="">Select a user by username</option>'; // Updated prompt
    allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `@${user.username}`; // Display username
        userDropdown.appendChild(option);
    });
    log(`âœ… Loaded ${allUsers.length} users for dropdown.`);
}

async function sendFriendRequest() {
    const receiverId = userDropdown.value;
    if (!receiverId) {
        show("Please select a user to send a request.", false);
        return;
    }
    if (!currentUser) {
        show("Please sign in to send friend requests.", false);
        return;
    }

    // Check for existing request (pending or accepted in either direction)
    const { data: existingRequest, error: checkError } = await sb
        .from('friends')
        .select('id, status')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${receiverId}),and(sender_id.eq.${receiverId},receiver_id.eq.${currentUser.id})`)
        .maybeSingle();

    if (checkError) {
        show(checkError.message, false);
        return;
    }

    if (existingRequest) {
        if (existingRequest.status === 'pending') {
            show("A pending friend request already exists with this user.", false);
        } else if (existingRequest.status === 'accepted') {
            show("You are already friends with this user.", false);
        } else { // Rejected or other status
            show("An interaction with this user already exists.", false);
        }
        return;
    }

    await safe("sendFriendRequest", signal =>
        sb.from('friends').insert({ sender_id: currentUser.id, receiver_id: receiverId }, { signal }).select()
    );
    show("Friend request sent!", true);
    log(`âœ… Sent friend request to ${receiverId}`);
    userDropdown.value = ""; // Clear selection
}

async function loadIncomingFriendRequests() {
    if (!currentUser) return;
    log("ğŸ”„ Loading incoming friend requests...");
    const { data, error } = await safe("loadIncomingRequests", signal =>
        sb.from('friends')
          .select('id, sender_id, profiles!sender_id(username)') // Fetch username from profiles table
          .eq('receiver_id', currentUser.id)
          .eq('status', 'pending')
          .order('created_at', { ascending: false })
          .limit(10)
    );

    if (error) {
        log(`âŒ loadIncomingRequests: ${error.message}`);
        return;
    }

    incomingRequestsList.innerHTML = "";
    if (data.length === 0) {
        incomingRequestsList.textContent = "No pending friend requests.";
    } else {
        data.forEach(req => {
            const div = document.createElement("div");
            div.className = "friend-request-item";
            div.innerHTML = `
                <span>Request from @${req.profiles.username}</span>
                <div class="flex-buttons">
                    <button class="btn-success" data-request-id="${req.id}" data-action="accept">Accept</button>
                    <button class="btn-danger" data-request-id="${req.id}" data-action="reject">Reject</button>
                </div>
            `;
            incomingRequestsList.appendChild(div);
        });
        incomingRequestsList.querySelectorAll('button').forEach(button => {
            button.onclick = handleFriendRequestAction;
        });
    }
    log(`âœ… Loaded ${data.length} incoming requests.`);
}

async function handleFriendRequestAction(event) {
    const requestId = event.target.dataset.requestId;
    const action = event.target.dataset.action; // 'accept' or 'reject'
    if (!requestId) return;
    if (!currentUser) {
        show("Please sign in to respond to friend requests.", false);
        return;
    }

    const { error } = await safe(`${action}FriendRequest`, signal =>
        sb.from('friends')
          .update({ status: action === 'accept' ? 'accepted' : 'rejected' }, { signal })
          .eq('id', requestId)
          .eq('receiver_id', currentUser.id) // Ensure only receiver can update
    );

    if (error) {
        show(`Failed to ${action} request: ${error.message}`, false);
    } else {
        show(`Request ${action}ed!`, true);
        log(`âœ… Friend request ${action}ed: ${requestId}`);
        await loadIncomingFriendRequests();
        await loadNotes(); // Reload notes to show new friend's notes
    }
}

/* ------------------------------------------------------------------
Â  Â NOTE OPERATIONS
------------------------------------------------------------------- */
async function loadNotes(){
Â  log("ğŸ”„ loadNotes()");
Â  const rows = await safe("loadNotes", signal =>
Â  Â  sb.from("notes")
Â  Â  Â  .select("*, profiles!user_id(username)", { signal }) // Fetch username from profiles table
Â  Â  Â  .order("created_at", { ascending:false })
Â  );
Â  if(!rows) return;

Â  list.innerHTML = "";
Â  rows.forEach(r=>{
Â  Â  const div = document.createElement("div");
Â  Â  div.className = "note";
    const noteOwner = r.profiles?.username ? `@${r.profiles.username}` : 'Unknown User';
Â  Â  div.innerHTML = `
      <div class="note-owner">${noteOwner}</div>
Â  Â  Â  <div class="meta">${new Date(r.created_at).toLocaleString()}</div>
Â  Â  Â  ${r.content}`;
Â  Â  list.appendChild(div);
Â  });
Â  log(`âœ… loaded ${rows.length} notes`);
}

async function saveNote(){
Â  const text = noteTxt.value.trim();
Â  if(!text){ show("Write something!",false); return; }
  if(!currentUser) { show("Please sign in to save notes.", false); return; }

Â  await safe("insert", signal =>
Â  Â  sb.from("notes")
Â  Â  Â  .insert({ user_id: currentUser.id, content: text }, { signal })
Â  Â  Â  .select()
Â  );
Â  noteTxt.value = "";
Â  show("Saved", true);
Â  await loadNotes();
}

/* ------------------------------------------------------------------
Â  Â EVENT HANDLERS
------------------------------------------------------------------- */

/* ---- Login ----
Â  Â redirectTo: location.href is OK because Supabase parses the #fragment.
*/
loginBtn.onclick = () =>
Â  sb.auth.signInWithOAuth({
Â  Â  provider: "google",
Â  Â  options : { redirectTo: location.href }
Â  });

/* ---- Logout ----
Â  Â We deliberately **reload** the app at a clean URL to:
Â  Â  Â â€¢ remove any lingering # / #access_token fragment
Â  Â  Â â€¢ start from a fresh state (clears memory leaks)
Â  Â This is simpler and less errorâ€‘prone than trying to mutate history.
Â  Â ** âš ï¸ Do NOT remove the replace() call; otherwise # may persist. **
*/
logoutBtn.onclick = async () => {
Â  log("â¡ï¸ logout click");

Â  const { error } = await sb.auth.signOut();
Â  if(error){ show(error.message,false); return; }

Â  window.location.replace(location.origin + location.pathname);
};

saveBtn.onclick = saveNote;
saveUsernameBtn.onclick = saveUsername; // Event listener for saving username
sendFriendRequestBtn.onclick = sendFriendRequest;


/* Optional network test */
pingBtn.onclick = () => safe("ping", signal =>
Â  sb.from("notes").select("id",{ head:true, signal }).limit(1)
);

/* ------------------------------------------------------------------
Â  Â AUTH LISTENER
------------------------------------------------------------------- */
sb.auth.onAuthStateChange(async (ev, sess) => {
Â  log("ğŸ“¢ " + ev);
Â  currentUser = sess?.user || null;
Â  updateUI();
Â  if(currentUser && ev !== "SIGNED_OUT") {
    // These functions now depend on currentUsername being set or loaded
    await loadUserProfile(); // Load or confirm auto-generated username
    await loadAllUsersForDropdown();
    await loadIncomingFriendRequests();
    await loadNotes();
  }
});

/* ------------------------------------------------------------------
Â  Â FIRST LOAD
------------------------------------------------------------------- */
const { data:{ session } } = await sb.auth.getSession();
currentUser = session?.user || null;
updateUI();
if(currentUser) {
    // These functions now depend on currentUsername being set or loaded
    await loadUserProfile();
    await loadAllUsersForDropdown();
    await loadIncomingFriendRequests();
    await loadNotes();
}
log("âœ… initial session ready");
</script>
</body>
</html>
